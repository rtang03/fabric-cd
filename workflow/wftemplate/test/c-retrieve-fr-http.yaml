{{- if eq .Values.clusterscope true }}
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: retrieve-from-http
spec:
  activeDeadlineSeconds: 3600
  # podGC:
  #   strategy: OnPodCompletion
  ttlStrategy:
    secondsAfterCompletion: 3600 # Time to live after workflow is completed, replaces ttlSecondsAfterFinished
    secondsAfterSuccess: 3600     # Time to live after workflow is successful
    secondsAfterFailure: 3600     # Time to live after workflow fails
  serviceAccountName: workflow
  entrypoint: main

  templates:
    # Retrieve file via http
    - name: retrieve-tmpl
{{ toYaml .Values.no_istio | indent 6 }}
      volumes:
        - name: gupload
          persistentVolumeClaim:
            claimName: {{ .Values.alias.input_pvc_gupload | quote }}
        - name: setup-script
          configMap:
            name: "orgadmin--setupsh"
            defaultMode: 0777
      inputs:
        parameters:
          - name: url
          - name: filename
          - name: path
          - name: pvc_gupload
        artifacts:
          - name: file
            path: /tmp/{{ .Values.alias.input_filename }}
            http:
              url: {{ .Values.alias.input_url | quote }}
      container:
        image: library/alpine:3.12.0
        command: ["sh", "-c"]
        workingDir: /
        args:
          - |-
            . /script/setup.sh
            if [ -f "/tmp/{{ .Values.alias.input_filename }}" ]; then
              echo "file {{ .Values.alias.input_filename }} downloaded"
              ls -ls /tmp/{{ .Values.alias.input_filename }}
              cp /tmp/{{ .Values.alias.input_filename }} {{ .Values.alias.input_path }}/{{ .Values.alias.input_filename }}
              printMessage "{{ .Values.alias.input_path }}/{{ .Values.alias.input_filename }} created" $?
            else
              echo "file not found"
              exit 1
            fi
        volumeMounts:
          - mountPath: /var/gupload/fileserver
            name: gupload
          - name: setup-script
            mountPath: /script/setup.sh
            subPath: setup.sh
{{- end }}
