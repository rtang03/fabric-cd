apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: bootstrap-ch-org2-
spec:
  entrypoint: main
  activeDeadlineSeconds: 300
  ttlStrategy:
    secondsAfterCompletion: 3600
    secondsAfterSuccess: 3600
    secondsAfterFailure: 3600
  serviceAccountName: workflow

  templates:
    - name: main
      steps:
        # delete files from gupload fileserver
        - - name: delete-files
            templateRef:
              name: gupload-up-file
              template: delete-files-tmpl
            arguments:
              parameters:
                - name: files
                  value: "fetchconfig.log;o2-config_update_in_envelope.pb"
        # curl org1 to invoke fetch-upload workflow. The curl does not response of workflow execution result.
        # It simply put the workflow execution on queue.
        - - name: curl-fetch-block
            templateRef:
              name: curl-event
              template: curl-tmpl
            arguments:
              parameters:
                - name: url
                  value: "http://argo.server/api/v1/events/n1/fetch-upload"
                - name: message
                  value: "{\\\"outfile\\\":\\\"channel_config--config.json\\\",\\\"cacert\\\":\\\"org2.net-tlscacert\\\",\\\"url\\\":\\\"gupload.org2.net:15443\\\"}"
        - - name: wait-60s
            templateRef:
              name: utility
              template: sleep
            arguments:
              parameters:
                - name: message
                  value: 60s
        # check fetchconfig.log exist in gupload fileserver and withtout error
        # fetchconfig.log exist only if "fetch-upload" is successfully processed
        - - name: check-fetchconfig-log-exist
            templateRef:
              name: gupload-up-file
              template: file-exist-and-no-error
            arguments:
              parameters:
                - name: infile
                  value: "fetchconfig.log"
        # add org2 configtx to the newly fetchblock, and send to org1 again
        - - name: neworg-configtx-upload-org1
            templateRef:
              name: neworg-config-update
              template: main
            arguments:
              parameters:
                - name: channelname
                  value: "loanapp"
                - name: config_block_json
                  value: "channel_config--config.json"
                - name: cacert
                  value: "org1.net-tlscacert"
                - name: outfile
                  value: "o2-config_update_in_envelope.pb"
                - name: url
                  value: "gupload.org1.net:15443"
        # curl org1 to invoke update-channel workflow
        - - name: curl-update-channel
            templateRef:
              name: curl-event
              template: curl-tmpl
            arguments:
              parameters:
                - name: url
                  value: "http://argo.server/api/v1/events/n1/update-channel"
                - name: message
                  value: "{\\\"channel\\\":\\\"loanapp\\\",\\\"envelope\\\":\\\"o2-config_update_in_envelope.pb\\\",\\\"url\\\":\\\"gupload.org2.net:15443\\\",\\\"cacert\\\":\\\"org1.net-tlscacert\\\"}"
        - - name: wait-70s
            templateRef:
              name: utility
              template: sleep
            arguments:
              parameters:
                - name: message
                  value: 70s
        # check fetchconfig.log exist in gupload fileserver and withtout error
        # fetchconfig.log exist only if "fetch-upload" is successfully processed
        - - name: check-updatechannel-log-exist
            templateRef:
              name: gupload-up-file
              template: file-exist-and-no-error
            arguments:
              parameters:
                - name: infile
                  value: "updatechannel.log"
        # - - name: join-channel-orgx
        #     templateRef:
        #       name: join-channel-orgx
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: channelname
        #           value: "loanapp"
        # - - name: update-anchor-peer
        #     templateRef:
        #       name: update-anchor-peer
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: channelname
        #           value: "loanapp"
        #         - name: host
        #           value: peer0.org2.net
        #         - name: port
        #           value: 15443
        #     continueOn:
        #       error: true
        #       failed: true
        # - - name: package-install-chaincode
        #     templateRef:
        #       name: package-install-chaincode
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: channelname
        #           value: "loanapp"
        #         - name: version
        #           value: 1
        # - - name: chaincode-id-resource
        #     templateRef:
        #       name: chaincode-id-resource
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: ccid
        #           value: "{{steps.package-install-chaincode.outputs.parameters.packageid}}"
        # - - name: sync-chaincode
        #     templateRef:
        #       name: argocd-cli
        #       template: argocd-app-sync
        #     arguments:
        #       parameters:
        #         - name: app
        #           value: "eventstore2"
        # - - name: approve-chaincode
        #     templateRef:
        #       name: approve-chaincode
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: channelname
        #           value: "loanapp"
        #         - name: sequence
        #           value: 1
        #         - name: version
        #           value: 1
        # - - name: smoke-test
        #     templateRef:
        #       name: smoke-test
        #       template: main
        #     arguments:
        #       parameters:
        #         - name: channelname
        #           value: "loanapp"
        #
