apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: wow-bootstrap-
spec:
  entrypoint: main
  serviceAccountName: workflow
  templates:
    - name: main
      steps:
        - - name: w-retrieve-from-http
            template: w1
            arguments:
              parameters:
                - name: workflowtemplate
                  value: "retrieve-from-http"
                - name: filename
                  value: org1.net-tlscacert.pem
                - name: path
                  value: /var/gupload/fileserver
                - name: url
                  value: https://storage.googleapis.com/fabric-cd-dev/workflow/secrets/n1/org1.net-tlscacert/tlscacert.pem
                - name: pvc_fabricfiles
                  value: pvc-org1
                - name: pvc_gupload
                  value: pvc-gupload1
        - - name: w-create-secret-from-file
            template: w2
            arguments:
              parameters:
                - name: workflowtemplate
                  value: "create-secret-from-file"
                - name: secretName
                  value: "org1.net-tlscacert"
                - name: filename
                  value: "org1.net-tlscacert.pem"
                - name: path
                  value: "/var/gupload/fileserver"
                - name: key
                  value: "tlscacert.pem"
                - name: pvc_fabricfiles
                  value: "pvc-org1"
                - name: pvc_gupload
                  value: "pvc-gupload1"

    - name: w1
      metadata:
        annotations:
          sidecar.istio.io/inject: "false"
      inputs:
        parameters:
          - name: workflowtemplate
          - name: filename
          - name: path
          - name: url
          - name: pvc_fabricfiles
          - name: pvc_gupload
      resource:
        action: create
        manifest: |
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: w1-{{inputs.parameters.workflowtemplate}}
          spec:
            arguments:
              parameters:
                - name: filename
                  value: {{inputs.parameters.filename}}
                - name: path
                  value: {{inputs.parameters.path}}
                - name: url
                  value: {{inputs.parameters.url}}
                - name: pvc_fabricfiles
                  value: {{inputs.parameters.pvc_fabricfiles}}
                - name: pvc_gupload
                  value: {{inputs.parameters.pvc_gupload}}
            workflowTemplateRef:
              name: {{inputs.parameters.workflowtemplate}}
        successCondition: status.phase == Succeeded
        failureCondition: status.phase in (Failed, Error)

    - name: w2
      metadata:
        annotations:
          sidecar.istio.io/inject: "false"
      inputs:
        parameters:
          - name: workflowtemplate
          - name: secretName
          - name: filename
          - name: path
          - name: key
          - name: pvc_fabricfiles
          - name: pvc_gupload
      resource:
        action: create
        manifest: |
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: w2-{{inputs.parameters.workflowtemplate}}
          spec:
            arguments:
              parameters:
              - name: secretName
                value: {{inputs.parameters.secretName}}
              - name: filename
                value: {{inputs.parameters.filename}}
              - name: path
                value: {{inputs.parameters.path}}
              - name: key
                value: {{inputs.parameters.key}}
              - name: pvc_fabricfiles
                value: {{inputs.parameters.pvc_fabricfiles}}
              - name: pvc_gupload
                value: {{inputs.parameters.pvc_gupload}}
            workflowTemplateRef:
              name: {{inputs.parameters.workflowtemplate}}
        successCondition: status.phase == Succeeded
        failureCondition: status.phase in (Failed, Error)
